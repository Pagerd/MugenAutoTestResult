+ source ./common/common_lib.sh
++ source /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/common_lib.sh
+++ python3 --version
+++ '[' 0 -eq 0 ']'
+++ source /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/common_lib_python.sh
+ main
++ type -t post_test
+ '[' -n function ']'
+ trap post_test EXIT INT HUP TERM
+ rpm -qa
+ grep expect
++ type -t config_params
+ '[' -n '' ']'
++ type -t pre_test
+ '[' -n function ']'
+ pre_test
+ LOG_INFO 'Start environmental preparation.'
+ message='Start environmental preparation.'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'Start environmental preparation.'
Thu Nov  9 05:55:24 2023 - INFO  - Start environmental preparation.
+ install_ruyi
+ curl -L -o ruyi https://mirror.iscas.ac.cn/ruyisdk/ruyi/testing/ruyi.amd64.20231107
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0  1 10.7M    1  145k    0     0    99k      0  0:01:50  0:00:01  0:01:49  101k 67 10.7M   67 7393k    0     0  2045k      0  0:00:05  0:00:03  0:00:02 2060k 71 10.7M   71 7831k    0     0  1716k      0  0:00:06  0:00:04  0:00:02 1726k 93 10.7M   93 10.0M    0     0  1874k      0  0:00:05  0:00:05 --:--:-- 1883k100 10.7M  100 10.7M    0     0  1912k      0  0:00:05  0:00:05 --:--:-- 2428k
+ chmod +x ruyi
++ realpath ruyi
+ ln -s /var/jenkins/workspace/ruyi-test/mugen-ruyi/testcases/cli-test/ruyi/ruyi /usr/bin/ruyi
++ get_ruyi_dir
++ ruyibase=
++ '[' '' == '' ']'
++ ruyibase=/root/.cache/
++ echo /root/.cache//ruyi
+ rm -rf /root/.cache//ruyi
+ LOG_INFO 'End of environmental preparation!'
+ message='End of environmental preparation!'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'End of environmental preparation!'
Thu Nov  9 05:55:32 2023 - INFO  - End of environmental preparation!
++ type -t run_test
+ '[' -n function ']'
+ run_test
+ LOG_INFO 'Start to run test.'
+ message='Start to run test.'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'Start to run test.'
Thu Nov  9 05:55:33 2023 - INFO  - Start to run test.
+ ruyi
usage: ruyi [-h] {install,i,list,toolchain,update,venv} ...
ruyi: error: the following arguments are required: {install,i,list,toolchain,update,venv}
+ CHECK_RESULT 2 0 1 'Check ruyi empty cmdline failed'
+ actual_result=2
+ expect_result=0
+ mode=1
+ error_log='Check ruyi empty cmdline failed'
+ exit_mode=0
+ '[' -z 2 ']'
+ '[' 1 -eq 0 ']'
+ test 2x == 0x
+ return 0
+ ruyi
+ grep usage
usage: ruyi [-h] {install,i,list,toolchain,update,venv} ...
+ CHECK_RESULT 0 0 0 'Check ruyi empty cmdline help failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi empty cmdline help failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi -h
+ grep usage
usage: ruyi [-h] {install,i,list,toolchain,update,venv} ...
+ CHECK_RESULT 0 0 0 'Check ruyi help failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi help failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi list
List of available packages:

+ CHECK_RESULT 0 0 0 'Check ruyi empty list failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi empty list failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
++ get_ruyi_dir
++ ruyibase=
++ '[' '' == '' ']'
++ ruyibase=/root/.cache/
++ echo /root/.cache//ruyi
+ '[' -d /root/.cache//ruyi ']'
+ CHECK_RESULT 0 0 0 'Check ruyi create cache directory failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi create cache directory failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi update
+ CHECK_RESULT 0 0 0 'Check ruyi update failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi update failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
++ ruyi list
++ grep -e '^* '
++ wc -l
+ pkgcnt=1
+ CHECK_RESULT 1 0 1 'Check ruyi list failed'
+ actual_result=1
+ expect_result=0
+ mode=1
+ error_log='Check ruyi list failed'
+ exit_mode=0
+ '[' -z 1 ']'
+ '[' 1 -eq 0 ']'
+ test 1x == 0x
+ return 0
+ ruyi list
+ grep 'Package declares'
+ CHECK_RESULT 1 0 1 'Check ruyi brief list failed'
+ actual_result=1
+ expect_result=0
+ mode=1
+ error_log='Check ruyi brief list failed'
+ exit_mode=0
+ '[' -z 1 ']'
+ '[' 1 -eq 0 ']'
+ test 1x == 0x
+ return 0
+ ruyi list --verbose
+ grep 'Package declares'
Package declares 2 distfiles:
+ CHECK_RESULT 0 0 0 'Check ruyi list verbose package failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi list verbose package failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi list --verbose
+ grep 'Binary artifacts'
### Binary artifacts
+ CHECK_RESULT 0 0 0 'Check ruyi list verbose artifacts failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi list verbose artifacts failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi list --verbose
+ grep 'Toolchain metadata'
### Toolchain metadata
+ CHECK_RESULT 0 0 0 'Check ruyi list verbose metadata failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi list verbose metadata failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
++ ruyi list
++ grep -e '^* '
++ head -n 1
++ cut '-d ' -f 2
+ pkgname=plct
+ ruyi install plct
info: downloading 
https://mirror.iscas.ac.cn/ruyisdk/dist/RuyiSDK-20231026-riscv64-plct-linux-gnu.
tar.xz to 
/root/.cache/ruyi/distfiles/RuyiSDK-20231026-riscv64-plct-linux-gnu.tar.xz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0  0  163M    0  8192    0     0   4483      0 10:38:43  0:00:01 10:38:42  4553  6  163M    6 10.3M    0     0  2152k      0  0:01:17  0:00:04  0:01:13 2165k  8  163M    8 14.3M    0     0  2538k      0  0:01:06  0:00:05  0:01:01 2550k 12  163M   12 21.1M    0     0  2902k      0  0:00:57  0:00:07  0:00:50 2914k 13  163M   13 22.0M    0     0  2902k      0  0:00:57  0:00:07  0:00:50 3634k 15  163M   15 24.8M    0     0  2893k      0  0:00:57  0:00:08  0:00:49 3648k 17  163M   17 28.2M    0     0  2950k      0  0:00:56  0:00:09  0:00:47 3760k 19  163M   19 31.9M    0     0  3030k      0  0:00:55  0:00:10  0:00:45 3600k 21  163M   21 35.4M    0     0  3074k      0  0:00:54  0:00:11  0:00:43 3370k 23  163M   23 38.1M    0     0  3051k      0  0:00:54  0:00:12  0:00:42 3285k 25  163M   25 41.1M    0     0  3049k      0  0:00:55  0:00:13  0:00:42 3324k 26  163M   26 43.9M    0     0  3032k      0  0:00:55  0:00:14  0:00:41 3193k 28  163M   28 47.4M    0     0  3066k      0  0:00:54  0:00:15  0:00:39 3144k 33  163M   33 54.6M    0     0  3187k      0  0:00:52  0:00:17  0:00:35 3421k 33  163M   33 55.6M    0     0  3199k      0  0:00:52  0:00:17  0:00:35 3576k 39  163M   39 64.1M    0     0  3311k      0  0:00:50  0:00:19  0:00:31 3909k 41  163M   41 67.9M    0     0  3335k      0  0:00:50  0:00:20  0:00:30 4085k 46  163M   46 75.3M    0     0  3416k      0  0:00:49  0:00:22  0:00:27 4234k 46  163M   46 76.1M    0     0  3418k      0  0:00:49  0:00:22  0:00:27 4185k 53  163M   53 87.5M    0     0  3518k      0  0:00:47  0:00:25  0:00:22 4260k 54  163M   54 88.6M    0     0  3515k      0  0:00:47  0:00:25  0:00:22 4195k 55  163M   55 91.5M    0     0  3498k      0  0:00:47  0:00:26  0:00:21 4067k 58  163M   58 95.2M    0     0  3502k      0  0:00:47  0:00:27  0:00:20 3872k 59  163M   59 98.0M    0     0  3483k      0  0:00:48  0:00:28  0:00:20 3732k 61  163M   61  101M    0     0  3477k      0  0:00:48  0:00:29  0:00:19 3236k 63  163M   63  103M    0     0  3456k      0  0:00:48  0:00:30  0:00:18 3151k 65  163M   65  107M    0     0  3444k      0  0:00:48  0:00:31  0:00:17 3156k 66  163M   66  109M    0     0  3426k      0  0:00:48  0:00:32  0:00:16 3000k 69  163M   69  113M    0     0  3416k      0  0:00:49  0:00:33  0:00:16 3030k 70  163M   70  115M    0     0  3400k      0  0:00:49  0:00:34  0:00:15 2945k 72  163M   72  119M    0     0  3406k      0  0:00:49  0:00:35  0:00:14 3103k 77  163M   77  127M    0     0  3454k      0  0:00:48  0:00:37  0:00:11 3507k 79  163M   79  130M    0     0  3446k      0  0:00:48  0:00:38  0:00:10 3559k 81  163M   81  133M    0     0  3439k      0  0:00:48  0:00:39  0:00:09 3574k 83  163M   83  137M    0     0  3420k      0  0:00:49  0:00:41  0:00:08 3528k 85  163M   85  139M    0     0  3419k      0  0:00:49  0:00:41  0:00:08 3498k 86  163M   86  142M    0     0  3406k      0  0:00:49  0:00:42  0:00:07 3037k 88  163M   88  145M    0     0  3401k      0  0:00:49  0:00:43  0:00:06 3048k 94  163M   94  154M    0     0  3443k      0  0:00:48  0:00:45  0:00:03 3463k 95  163M   95  157M    0     0  3435k      0  0:00:48  0:00:46  0:00:02 3546k 97  163M   97  160M    0     0  3433k      0  0:00:48  0:00:47  0:00:01 3532k100  163M  100  163M    0     0  3444k      0  0:00:48  0:00:48 --:--:-- 3721k
info: extracting RuyiSDK-20231026-riscv64-plct-linux-gnu.tar.xz for package 
plct-20231026
info: package plct-20231026 installed to 
/root/.cache/ruyi/toolchains/x86_64/plct-20231026
+ CHECK_RESULT 0 0 0 'Check ruyi install package failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi install package failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi install plct
+ grep 'skipping already installed package plct'
info: skipping already installed package plct-20231026
+ CHECK_RESULT 0 0 0 'Check ruyi install duplicate package failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi install duplicate package failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi install name:plct
+ grep 'skipping already installed package plct'
info: skipping already installed package plct-20231026
+ CHECK_RESULT 0 0 0 'Check ruyi install duplicate package by name failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi install duplicate package by name failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi list profiles
generic
sipeed-lpi4a (needs flavor(s): {'xthead'})
milkv-duo
+ CHECK_RESULT 0 0 0 'Check ruyi profile'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi profile'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
++ ruyi list profiles
++ head -n 1
Traceback (most recent call last):
  File "/tmp/onefile_2809_1699509965_820074/__main__.py", line 11, in <module>
  File "/tmp/onefile_2809_1699509965_820074/ruyi/cli/__init__.py", line 136, in main
  File "/tmp/onefile_2809_1699509965_820074/ruyi/ruyipkg/profile_cli.py", line 19, in cli_list_profiles
  File "/tmp/onefile_2809_1699509965_820074/ruyi/log.py", line 20, in stdout
  File "/tmp/onefile_2809_1699509965_820074/rich/console.py", line 1673, in print
  File "/tmp/onefile_2809_1699509965_820074/rich/console.py", line 865, in __exit__
  File "/tmp/onefile_2809_1699509965_820074/rich/console.py", line 823, in _exit_buffer
  File "/tmp/onefile_2809_1699509965_820074/rich/console.py", line 2065, in _check_buffer
BrokenPipeError: [Errno 32] Broken pipe
Exception ignored in: <_io.TextIOWrapper name='<stdout>' mode='w' encoding='utf-8'>
BrokenPipeError: [Errno 32] Broken pipe
+ proname=generic
+ ruyi venv --toolchain plct generic test-venv
+ grep 'The virtual environment is now created.'
info: The virtual environment is now created.
+ CHECK_RESULT 0 0 0 'Check ruyi venv install failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi venv install failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ '[' -f ./test-venv/bin/ruyi-activate ']'
+ CHECK_RESULT 0 0 0 'Check ruyi venv activate file failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check ruyi venv activate file failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ oldps1=
+ source ./test-venv/bin/ruyi-activate
++ '[' ./test-venv/bin/ruyi-activate = oe_test_ruyi.sh ']'
++ ruyi-deactivate nondestructive
++ '[' -z '' ']'
++ hash -r
++ '[' -z '' ']'
++ unset RUYI_VENV
++ unset RUYI_VENV_PROMPT
++ '[' '!' nondestructive = nondestructive ']'
++ RUYI_VENV=/var/jenkins/workspace/ruyi-test/mugen-ruyi/testcases/cli-test/ruyi/test-venv
++ export RUYI_VENV
++ _RUYI_OLD_PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
++ PATH=/var/jenkins/workspace/ruyi-test/mugen-ruyi/testcases/cli-test/ruyi/test-venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
++ export PATH
++ hash -r
+++ basename /var/jenkins/workspace/ruyi-test/mugen-ruyi/testcases/cli-test/ruyi/test-venv
++ RUYI_VENV_PROMPT=test-venv
++ export RUYI_VENV_PROMPT
++ '[' -z '' ']'
++ _RUYI_OLD_PS1=
++ PS1='«Ruyi test-venv» '
++ export PS1
+ echo '«Ruyi test-venv» '
+ grep test-venv
«Ruyi test-venv» 
+ CHECK_RESULT 0 0 0 'Check activate ruyi venv PS1 failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check activate ruyi venv PS1 failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ ruyi-deactivate
+ '[' -z _ ']'
+ PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
+ export PATH
+ unset _RUYI_OLD_PATH
+ hash -r
+ '[' -z _ ']'
+ PS1=
+ export PS1
+ unset _RUYI_OLD_PS1
+ unset RUYI_VENV
+ unset RUYI_VENV_PROMPT
+ '[' '!' '' = nondestructive ']'
+ unset -f ruyi-deactivate
+ '[' '' == '' ']'
+ CHECK_RESULT 0 0 0 'Check deactivate ruyi venv PS1 failed'
+ actual_result=0
+ expect_result=0
+ mode=0
+ error_log='Check deactivate ruyi venv PS1 failed'
+ exit_mode=0
+ '[' -z 0 ']'
+ '[' 0 -eq 0 ']'
+ test 0x '!=' 0x
+ return 0
+ rm -rf test-venv
+ LOG_INFO 'End of the test.'
+ message='End of the test.'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'End of the test.'
Thu Nov  9 06:06:51 2023 - INFO  - End of the test.
+ CASE_RESULT 0
+ case_re=0
+ test -z ''
+ test 0 -eq 0
+ LOG_INFO 'succeed to execute the case.'
+ message='succeed to execute the case.'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'succeed to execute the case.'
Thu Nov  9 06:06:52 2023 - INFO  - succeed to execute the case.
+ exec_result=
+ exit 0
+ post_test
+ LOG_INFO 'start environment cleanup.'
+ message='start environment cleanup.'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'start environment cleanup.'
Thu Nov  9 06:06:53 2023 - INFO  - start environment cleanup.
+ remove_ruyi
+ rm -f ruyi
+ rm -f /usr/bin/ruyi
+ export RUYI_DEBUG=
+ RUYI_DEBUG=
++ get_ruyi_dir
++ ruyibase=
++ '[' '' == '' ']'
++ ruyibase=/root/.cache/
++ echo /root/.cache//ruyi
+ rm -rf /root/.cache//ruyi
+ LOG_INFO 'Finish environment cleanup!'
+ message='Finish environment cleanup!'
+ python3 /var/jenkins/workspace/ruyi-test/mugen-ruyi/libs/locallibs/mugen_log.py --level info --message 'Finish environment cleanup!'
Thu Nov  9 06:07:01 2023 - INFO  - Finish environment cleanup!
